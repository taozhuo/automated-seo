{
  "id": 4231030,
  "title": "Help with Implementing Lag Compensation",
  "slug": "help-with-implementing-lag-compensation",
  "url": "https://devforum.roblox.com/t/help-with-implementing-lag-compensation/4231030",
  "category_id": 55,
  "category_name": "Scripting Support",
  "created_at": "2026-01-08T13:31:22.692Z",
  "last_posted_at": "2026-01-08T17:10:13.483Z",
  "views": 44,
  "reply_count": 0,
  "like_count": 0,
  "tags": [],
  "posts": [
    {
      "id": 13659677,
      "username": "GGreenBBoy123",
      "content_raw": "",
      "content_html": "<p>So, recently, I am trying to make a lag compensation script because I want to try to make a battleground game.</p>\n<p>I do this because I am think if client side create hitbox will cause a security issue, on the other hand, create a hitbox on the server side also will cause a delay issue: attacker may hit a player already in his view, but can’t do damage actually.</p>\n<p>Therefore, I want to create a lag compensation script. By rewinding on the server side using the ping of a player, it can calculate the position of a player in the seconds of delay ago.</p>\n<p>Below are script on the server side and client side. Client side script create a green box when I click on the mouse. After it reach server, it create another red box after calculating the position using the ping.</p>\n<p>However, the issue is that the red box is still far away from the green box (around 1-2studs). I don’t expect they can have a completely same position, but I expect it at least near to each other.</p>\n<p>Why this happening, could anyone help me? I would really happy if anyone can provide the reason and answer for this. Thank you</p>\n<p><strong>Scripts are written by AI, but i checked that the code are all make sense for me</strong></p>\n<p>Server Script Code:</p>\n<pre data-code-wrap=\"lua\"><code class=\"lang-lua\">local RunService = game:GetService(\"RunService\")\nlocal Players = game:GetService(\"Players\")\nlocal ReplicatedStorage = game:GetService(\"ReplicatedStorage\")\nlocal Debris = game:GetService(\"Debris\")\n\n-- SETUP REMOTE EVENT\nlocal hitEvent = Instance.new(\"RemoteEvent\")\nhitEvent.Name = \"HitRequest\"\nhitEvent.Parent = ReplicatedStorage\n\n-- CONFIGURATION\nlocal BUFFER_TIME = 1.0 -- How many seconds of history to keep\n\n-- DATA STORAGE: PlayerHistory[Player] = { {Time = 10, CFrame = ...}, ... }\nlocal PlayerHistory = {}\n\n-------------------------------------------------------------------------------\n-- HELPER: CALCULATE POSITION AT EXACT TIME (Step 3)\n-------------------------------------------------------------------------------\nlocal function GetCFrameAtTime(targetPlayer, targetTime)\n\tlocal history = PlayerHistory[targetPlayer]\n\tif not history or #history &lt; 2 then return nil end\n\n\t-- Iterate backwards (Newest -&gt; Oldest) to find the time slot\n\tfor i = #history, 2, -1 do\n\t\tlocal newerRecord = history[i]\n\t\tlocal olderRecord = history[i - 1]\n\n\t\t-- Check if targetTime is between these two records\n\t\tif targetTime &gt;= olderRecord.Time and targetTime &lt;= newerRecord.Time then\n\n\t\t\t-- Calculate the difference in time between the two records\n\t\t\tlocal timeGap = newerRecord.Time - olderRecord.Time\n\t\t\tif timeGap &lt;= 0 then return newerRecord.CFrame end -- Safety check\n\n\t\t\t-- Calculate the Ratio (Alpha)\n\t\t\t-- Example: If Older is 1.0s, Newer is 2.0s, and Target is 1.5s\n\t\t\t-- (1.5 - 1.0) / (2.0 - 1.0) = 0.5 (50%)\n\t\t\tlocal alpha = (targetTime - olderRecord.Time) / timeGap\n\t\t\t\n\t\t\tprint(alpha)\n\n\t\t\t-- Interpolate: Return the position exactly between the two points\n\t\t\treturn olderRecord.CFrame:Lerp(newerRecord.CFrame, alpha)\n\t\tend\n\tend\n\n\t-- If time is too old (older than buffer) or too new (future), return nil or closest\n\treturn nil\nend\n\n-------------------------------------------------------------------------------\n-- CORE: RECORD POSITIONS (Step 1)\n-------------------------------------------------------------------------------\nRunService.Heartbeat:Connect(function()\n\tlocal serverTime = workspace.DistributedGameTime\n\n\tfor _, player in pairs(Players:GetPlayers()) do\n\t\tif player.Character and player.Character:FindFirstChild(\"HumanoidRootPart\") then\n\t\t\tlocal hrp = player.Character.HumanoidRootPart\n\n\t\t\t-- Initialize table if new\n\t\t\tif not PlayerHistory[player] then PlayerHistory[player] = {} end\n\n\t\t\t-- Add new record\n\t\t\ttable.insert(PlayerHistory[player], {\n\t\t\t\tTime = serverTime,\n\t\t\t\tCFrame = hrp.CFrame\n\t\t\t})\n\n\t\t\t-- Cleanup old records (Buffer)\n\t\t\t-- If the oldest record (index 1) is older than BUFFER_TIME, remove it\n\t\t\twhile #PlayerHistory[player] &gt; 0 and (serverTime - PlayerHistory[player][1].Time) &gt; BUFFER_TIME do\n\t\t\t\ttable.remove(PlayerHistory[player], 1)\n\t\t\tend\n\t\tend\n\tend\nend)\n\n-------------------------------------------------------------------------------\n-- LOGIC: HANDLE HIT REQUEST (Step 2)\n-------------------------------------------------------------------------------\nhitEvent.OnServerEvent:Connect(function(attacker, targetPlayer)\n\tif not targetPlayer or not targetPlayer.Character then return end\n\n\t-- A. Get Attacker's Ping (One-Way Latency)\n\tlocal ping = attacker:GetNetworkPing()\n\tlocal oneWayLatency = ping / 2\n\n\tprint(oneWayLatency)\n\n\t-- B. Calculate the Server Time when the client \"saw\" the target\n\tlocal serverNow = workspace.DistributedGameTime\n\tlocal pastTime = serverNow - oneWayLatency\n\n\t-- C. Get the position of the Target at that exact past time\n\tlocal pastCFrame = GetCFrameAtTime(targetPlayer, pastTime)\n\n\tif pastCFrame then\n\t\tprint(string.format(\"Hit Verified! Rewound %.3fs\", oneWayLatency))\n\n\t\t-- VISUALIZATION: Create a Red Ghost to show where the server calculated the hit\n\t\tlocal ghost = Instance.new(\"Part\")\n\t\tghost.Size = Vector3.new(4, 5, 1)\n\t\tghost.Anchored = true\n\t\tghost.CanCollide = false\n\t\tghost.Material = Enum.Material.Neon\n\t\tghost.Color = Color3.fromRGB(255, 0, 0) -- Red = Calculated Hit Position\n\t\tghost.Transparency = 0.5\n\t\tghost.CFrame = pastCFrame\n\t\tghost.Parent = workspace\n\t\tDebris:AddItem(ghost, 1) -- Remove after 1 second\n\telse\n\t\twarn(\"Could not calculate past position (Packet loss or too much lag)\")\n\tend\nend)\n\n-- Cleanup when player leaves\nPlayers.PlayerRemoving:Connect(function(player)\n\tPlayerHistory[player] = nil\nend)\n</code></pre>\n<p>Client Side Code:</p>\n<pre data-code-wrap=\"lua\"><code class=\"lang-lua\">local Players = game:GetService(\"Players\")\nlocal ReplicatedStorage = game:GetService(\"ReplicatedStorage\")\nlocal UserInputService = game:GetService(\"UserInputService\")\nlocal Debris = game:GetService(\"Debris\") -- Service to handle auto-deletion\n\nlocal hitEvent = ReplicatedStorage:WaitForChild(\"HitRequest\")\nlocal localPlayer = Players.LocalPlayer\n\nUserInputService.InputBegan:Connect(function(input, processed)\n\tif processed then return end\n\n\tif input.UserInputType == Enum.UserInputType.MouseButton1 then\n\t\t-- 1. Send request to server\n\t\thitEvent:FireServer(localPlayer)\n\n\t\t-- 2. Create Client-Side Visual Box (Immediate)\n\t\tlocal character = localPlayer.Character\n\t\tif character and character:FindFirstChild(\"HumanoidRootPart\") then\n\t\t\tlocal hrp = character.HumanoidRootPart\n\t\t\t\n\t\t\tlocal visualBox = Instance.new(\"Part\")\n\t\t\tvisualBox.Name = \"ClientDebugBox\"\n\t\t\tvisualBox.Size = Vector3.new(4, 5, 1) -- Approximate Hitbox size\n\t\t\tvisualBox.CFrame = hrp.CFrame\n\t\t\tvisualBox.Anchored = true\n\t\t\tvisualBox.CanCollide = false\n\t\t\tvisualBox.Material = Enum.Material.Neon\n\t\t\tvisualBox.Color = Color3.fromRGB(0, 255, 0) -- Green = Client Side\n\t\t\tvisualBox.Transparency = 0.5\n\t\t\tvisualBox.Parent = workspace\n\t\t\t\n\t\t\t-- 3. Destroy after 2 seconds\n\t\t\tDebris:AddItem(visualBox, 2)\n\t\tend\n\tend\nend)\n</code></pre>",
      "created_at": "2026-01-08T13:31:22.936Z",
      "likes": 0,
      "post_number": 1
    },
    {
      "id": 13660752,
      "username": "BonesIsUseless",
      "content_raw": "",
      "content_html": "<p>you’re probably seeing the small gap because of your <code>oneWayLatency</code> and physics delay</p>\n<pre data-code-wrap=\"lua\"><code class=\"lang-lua\">local latency = ping + 0.03 -- account for the built-in \"buffer\"\n</code></pre>\n<p>look into <a href=\"https://devforum.roblox.com/t/chickynoid-server-authoritative-character-replacement/1660558\">chickynoid authoritative replication</a>  <img src=\"/images/emoji/twitter/man_shrugging.png?v=14\" title=\":man_shrugging:\" class=\"emoji\" alt=\":man_shrugging:\" loading=\"lazy\" width=\"20\" height=\"20\"></p>",
      "created_at": "2026-01-08T16:37:40.123Z",
      "likes": 0,
      "post_number": 2
    },
    {
      "id": 13661023,
      "username": "fletc3her",
      "content_raw": "",
      "content_html": "<p>You might look into the new <a href=\"https://create.roblox.com/docs/projects/server-authority\">Server Authority</a> which is currently in beta.</p>",
      "created_at": "2026-01-08T17:10:13.483Z",
      "likes": 0,
      "post_number": 3
    }
  ]
}